<!DOCTYPE html>
<html>
<head>
  <title>Vue Â» a simple web-based directory image viewer</title>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function(){
      fileSelector = document.querySelector("input");
      previews = document.querySelector(".previews");
      overlay = document.querySelector(".overlay");
      var viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      var isMaximized = function(){
        !overlay.classList.contains("hidden");
      }

      /**
        * Conserve aspect ratio of the orignal region. Useful when shrinking/enlarging
        * images to fit into a certain area.
        *
        * @param {Number} srcWidth Source area width
        * @param {Number} srcHeight Source area height
        * @param {Number} maxWidth Fittable area maximum available width
        * @param {Number} maxHeight Fittable area maximum available height
        * @return {Object} { width, heigth }
        */
      function calculateAspectRatioFit(srcWidth, srcHeight, maxWidth, maxHeight) {
        var ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);

        return { width: srcWidth * ratio, height: srcHeight * ratio };
      }

      var maximize = function(event) {
        image = event.currentTarget || event;
        image.classList.toggle("maximized");
        imageSource = image.src;
        fullWidthImage = new Image();
        fullWidthImage.src = imageSource;
        aspectRatio = calculateAspectRatioFit(fullWidthImage.width, fullWidthImage.height, viewportWidth, viewportHeight)
        fullWidthImage.width, fullWidthImage.height = aspectRatio.width, aspectRatio.height;
        overlay.appendChild(fullWidthImage);

        overlay.classList.toggle("hidden");
        previews.classList.toggle("hidden");
        overlay.classList.toggle("visible");
      };

      var selectRight = function(){
        if(isMaximized){ 
          maximizedImage = document.querySelector(".maximized");
          imageToMaximize = maximizedImage.nextElementSibling;
          imageToMaximize.classList.toggle("selected");
          unmaximize();
          maximize(imageToMaximize);
        } else {
          selectedElement = document.querySelector(".selected");

          if(selectedElement) {
            selectedElement.classList.toggle("selected");
            selectedElement.nextElementSibling.classList.toggle("selected");
          } else {
            previews.children[0].classList.toggle("selected");
          }
        }
      }

      var selectLeft = function(){
        if(isMaximized){
          maximizedImage = document.querySelector(".maximized");
          imageToMaximize = maximizedImage.previousElementSibling;
          imageToMaximize.classList.toggle("selected");
          unmaximize();
          maximize(imageToMaximize);
        } else {
          selectedElement = document.querySelector(".selected");

          if(selectedElement) {
            selectedElement.classList.toggle("selected");
            selectedElement.previousElementSibling.classList.toggle("selected");
          } else {
            previews.children[0].classList.toggle("selected");
          }
        }
      }

      var unmaximize = function(image = overlay.children[0]) {
        maximizedImagePreview = document.querySelector(".maximized");
        maximizedImagePreview.classList.toggle("maximized");
        overlay.removeChild(image);
        previews.classList.toggle("hidden");
        overlay.classList.toggle("hidden");
        overlay.classList.toggle("visible");
      };

      document.onkeydown = function(event) {
        event = event || window.event;
        var isEscape, isLeft, isRight, isUp, isDown = false;

        if ("key" in event) {
          isEscape = (event.key == "Escape" || event.key == "Esc");
          isLeft = (event.key == "ArrowLeft");
          isRight = (event.key == "ArrowRight");
          isUp = (event.key == "ArrowUp");
          isDown = (event.key == "ArrowDown");
          isEnter = (event.key == "Enter");
        } else {
          isEscape = (event.keyCode == 27);
          isLeft = (event.keyCode == 37);
          isRight = (event.keyCode == 39);
          isUp = (event.keyCode == 38);
          isDown = (event.keyCode == 40);
        }

        if (isEscape) { unmaximize(); }
        if (isLeft) { selectLeft(); }
        if (isRight) { selectRight(); }
        if (isUp) { selectUp(); }
        if (isDown) { selectDown(); }
      };

      function filesSelected(event) {
        files = event.currentTarget.files;
        console.log(files.length + " files were selected"); 

        function readAndPreview(file){
          // Make sure `file.name` matches our extensions criteria
          if ( /\.(jpe?g|png|gif)$/i.test(file.name) ) {

            var reader = new FileReader();

            reader.addEventListener("load", function () {              
              var image = new Image();
              image.title = file.name;
              image.src = this.result;
              aspectRatio = calculateAspectRatioFit(image.width, image.height, 150, 150)
              image.width, image.height = aspectRatio.width, aspectRatio.height;
              previews.appendChild( image );
              image.addEventListener("click", maximize);
            }, false);

            if (file) {
              reader.readAsDataURL(file);
            }
          }
        }

        if (files) {
          [].forEach.call(files, readAndPreview);
        }
      }

      fileSelector.addEventListener("change", filesSelected);
    });
  </script>

  <style type="text/css">
    .overlay {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background-color: black;
      display: none;
    }

    .hidden {
      display: none;
    }

    .visible {
      display: initial;
    }

    .selected {
      border: 1px solid black;
    }

    footer {
      margin-top: 2em;
    }
  </style>
</head>
<body>
<h1>Vue</h1>
<p>Select a directory on your machine using the file picker below.</p>
<input type="file" webkitdirectory directory multiple />
<div class="previews"></div>
<div class="overlay hidden"></div>

<footer>
  Privacy note: the images loaded into Vue will be loaded inside of <strong>your</strong> browser. This means they're never uploaded anywhere else. You can 
  verify this since Vue is <a href="https://github.com/olivierlacan/vue/blob/master/index.html">an open source project</a>.
</footer>
</body>
</html>
